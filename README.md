# Microservice Template

This repository is a template for building Python microservices using FastAPI. It provides a ready-to-use structure with a testing suite and a CI pipeline for automated testing, linting, and Docker image publishing.

## Features
- **FastAPI**: Modern, fast web framework for building APIs.
- **Testing Suite**: Includes sample tests and setup for pytest.
- **Continuous Integration**: GitHub Actions workflow for testing, linting, and building Docker images on push.
- **Docker Support**: Dockerfile and docker-compose setup for local development and CI.

## Usage
1. **Clone this repository** and use it as a starting point for your microservice.
2. **Develop your API** in the `src/` directory.
3. **Write tests** in the `tests/` directory.
4. **Run tests locally**:
   ```bash
   docker compose -f tests/docker-compose.yaml --project-directory tests up --build --abort-on-container-exit --exit-code-from test
   ```
5. **CI/CD**: On each push to `main`, the GitHub Actions workflow will run tests, lint your code, and (if applicable) build and push a Docker image.

## Customization
- Update the API logic in `src/server.py`.
- Adjust dependencies in `requirements.txt`.
- Change the Docker image name in the workflow by editing the `DOCKER_IMAGE_NAME` environment variable at the top of `.github/workflows/release-and-nightly.yaml`.

## Further Customization
### Change the language
It is possible to write the microservice in other languages. 
Because the tests only call the endpoints, a pattern in microservice architecture,
you only want to change the top-level Dockerfile and all of the code in the `src` folder.
If you already wrote tests for the microservice, you can rewrite an entire microservice in a different language
while keeping the tests in place, and substitute with relative ease.
This can be helpful in prototyped projects, or when speed becomes an issue as the project is scaled.

Note: This is part of the reason why I preferred `pip` to the much-better `poetry`. 
I wanted to keep the test-suite dependencies independent of the code base.

### Other System Components
If the microservice has dependencies such as databases, such as `redis`, 
You can add them to the testing `docker-compose.yaml` as needed


## OpenAPI Response Test

The test in `tests/test_openapi_responses.py` automatically checks that all API endpoints documented in the OpenAPI specification (generated by FastAPI) and expected to return a 200 response actually do so in practice. It does this by:
- Fetching the OpenAPI schema from the running service.
- Iterating over all endpoints and HTTP methods with a documented 200 response.
- Sending requests (with example payloads if needed) to each endpoint.
- Asserting that the response status code is 200.

**Intention:**
This test ensures that your API implementation matches its documentation. If an endpoint is documented to return a 200 response, but does not, the test will fail. This helps catch discrepancies between code and documentation, and ensures that clients relying on the OpenAPI spec can trust the documented behavior.

**Importance:**
- Prevents drift between API code and documentation.
- Increases confidence for API consumers and integrators.
- Encourages accurate and up-to-date OpenAPI specs as part of your CI pipeline.

## Credits
A lot of the philosophy here is due [Dmitry Shnayder](https://github.com/dshnayder), I learned a lot working together.

## License
MIT

## Future Plans

1. I may create a good `.devenvironment` to use with VS Code. I am trying to understand how to make it portable for different languages.
2. I may add versions for different languages, maybe in different branches on the same repo.
3. I may actually include a version with `poetry` for pure Python projects.
